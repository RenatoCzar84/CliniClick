{% extends "base/base.html" %}
{% load static %}

{% block title %}Cadastro | Cliniclick{% endblock %}

{% block content %}
<section class="py-4">
  <h2 class="section-title mb-3">Cadastro de Usuário</h2>
  <div class="card shadow-sm">
    <div class="card-header card-header-gradient text-white">
      <strong>Preencha seus dados</strong>
    </div>
    <div class="card-body">
      <form method="post" novalidate>
        {% csrf_token %}

        {% if form.non_field_errors %}
          <div class="alert alert-danger">{{ form.non_field_errors }}</div>
        {% endif %}

        <div class="row g-3">
          <!-- Você pode deixar {{ form.as_p }} para ir rápido,
               mas aqui vai uma grade básica para UX melhor -->
          <div class="col-md-6">
            <label class="form-label">Usuário</label>
            {{ form.username }}
            {{ form.username.errors }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Email</label>
            {{ form.email }}
            {{ form.email.errors }}
          </div>

          <div class="col-md-6">
            <label class="form-label">Nome</label>
            {{ form.first_name }}
            {{ form.first_name.errors }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Sobrenome</label>
            {{ form.last_name }}
            {{ form.last_name.errors }}
          </div>

          <div class="col-md-6">
            <label class="form-label">CPF</label>
            {{ form.cpf }}
            <span id="erro-cpf" class="text-danger small d-block mt-1" style="display:none;"></span>
            {{ form.cpf.errors }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Telefone</label>
            {{ form.telefone }}
            {{ form.telefone.errors }}
          </div>

          <div class="col-4">
            <label class="form-label">CEP</label>
            {{ form.cep }}
            {{ form.cep.errors }}
          </div>
          <div class="col-8">
            <label class="form-label">Rua</label>
            {{ form.rua }}
            {{ form.rua.errors }}
          </div>

          <div class="col-4">
            <label class="form-label">Número</label>
            {{ form.numero }}
            {{ form.numero.errors }}
          </div>
          <div class="col-4">
            <label class="form-label">Bairro</label>
            {{ form.bairro }}
            {{ form.bairro.errors }}
          </div>
          <div class="col-3">
            <label class="form-label">Cidade</label>
            {{ form.cidade }}
            {{ form.cidade.errors }}
          </div>
          <div class="col-1">
            <label class="form-label">UF</label>
            {{ form.estado }}
            {{ form.estado.errors }}
          </div>

          <div class="col-12">
            <label class="form-label">Complemento</label>
            {{ form.complemento }}
            {{ form.complemento.errors }}
          </div>

          <div class="col-md-4">
            <label class="form-label">Data de Nascimento</label>
            {{ form.data_nascimento }}
            {{ form.data_nascimento.errors }}
          </div>
          <div class="col-md-4">
            <label class="form-label">Plano de Saúde</label>
            {{ form.plano_saude }}
            {{ form.plano_saude.errors }}
          </div>
          <div class="col-md-4">
            <label class="form-label">Apelido</label>
            {{ form.apelido }}
            {{ form.apelido.errors }}
          </div>

          <div class="col-md-6">
            <label class="form-label">Senha</label>
            {{ form.password1 }}
            {{ form.password1.errors }}
          </div>
          <div class="col-md-6">
            <label class="form-label">Confirmar Senha</label>
            {{ form.password2 }}
            {{ form.password2.errors }}
          </div>
        </div>

        <div class="mt-4 d-flex gap-2">
          <button type="submit" class="btn btn-primary">Cadastrar</button>
          <a href="{% url 'index' %}" class="btn btn-outline-secondary">Cancelar</a>
        </div>
      </form>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  // Limpar campos sensíveis ao carregar (evita autocomplete teimoso)
  const firstLoadKeys = ["id_cpf","id_telefone","id_cep","id_estado"];
  firstLoadKeys.forEach(id => { const el = document.getElementById(id); if (el) el.value = ""; });

  // Máscaras leves (formato visual; normalização é no backend)
  function digits(v){ return (v||"").replace(/\D+/g,""); }

  const cpf = document.getElementById("id_cpf");
  const tel = document.getElementById("id_telefone");
  const cep = document.getElementById("id_cep");
  const uf  = document.getElementById("id_estado");
  const nome = document.getElementById("id_first_name");
  const sobrenome = document.getElementById("id_last_name");
  const erroCpf = document.getElementById("erro-cpf");

  if (cpf){
    cpf.addEventListener("input", e=>{
      let v = digits(e.target.value).slice(0,11);
      // 000.000.000-00
      if (v.length > 9) e.target.value = v.replace(/^(\d{3})(\d{3})(\d{3})(\d{0,2}).*$/, "$1.$2.$3-$4");
      else if (v.length > 6) e.target.value = v.replace(/^(\d{3})(\d{3})(\d{0,3}).*$/, "$1.$2.$3");
      else if (v.length > 3) e.target.value = v.replace(/^(\d{3})(\d{0,3}).*$/, "$1.$2");
      else e.target.value = v;
      erroCpf.style.display = "none";
    });
    // Validação matemática simples no front (espelha o back)
    function cpfValido(n){
      n = digits(n);
      if (n.length !== 11 || /^(\d)\1{10}$/.test(n)) return false;
      let soma=0; for(let i=0;i<9;i++) soma += parseInt(n[i])*(10-i);
      let d1=(soma*10)%11; if (d1===10) d1=0; if (d1!==parseInt(n[9])) return false;
      soma=0; for(let i=0;i<10;i++) soma += parseInt(n[i])*(11-i);
      let d2=(soma*10)%11; if (d2===10) d2=0; return d2===parseInt(n[10]);
    }
    cpf.addEventListener("blur", ()=>{
      if (cpf.value && !cpfValido(cpf.value)){
        erroCpf.textContent = "CPF inválido.";
        erroCpf.style.display = "block";
      }
    });
  }

  if (tel){
    tel.addEventListener("input", e=>{
      let v = digits(e.target.value).slice(0,11);
      if (v.length > 10) e.target.value = v.replace(/^(\d{2})(\d{5})(\d{0,4}).*$/, "($1) $2-$3");
      else if (v.length > 6) e.target.value = v.replace(/^(\d{2})(\d{0,4})(\d{0,4}).*$/, "($1) $2-$3");
      else if (v.length > 2) e.target.value = v.replace(/^(\d{2})(\d{0,5}).*$/, "($1) $2");
      else e.target.value = v;
    });
  }

  if (cep){
    cep.addEventListener("input", e=>{
      let v = digits(e.target.value).slice(0,8);
      if (v.length > 5) e.target.value = v.replace(/^(\d{5})(\d{0,3}).*$/, "$1-$2");
      else e.target.value = v;
    });
    // ViaCEP
    cep.addEventListener("blur", ()=>{
      const v = digits(cep.value);
      if (v.length !== 8) return;
      fetch(`https://viacep.com.br/ws/${v}/json/`).then(r=>r.json()).then(data=>{
        if (data && !data.erro){
          const rua = document.getElementById("id_rua");
          const bairro = document.getElementById("id_bairro");
          const cidade = document.getElementById("id_cidade");
          const estado = document.getElementById("id_estado");
          if (rua) rua.value = data.logradouro || "";
          if (bairro) bairro.value = data.bairro || "";
          if (cidade) cidade.value = data.localidade || "";
          if (estado) estado.value = (data.uf || "").toUpperCase();
        }
      }).catch(()=>{});
    });
  }

  if (uf){
    uf.addEventListener("input", e=>{
      e.target.value = (e.target.value || "").toUpperCase().slice(0,2);
    });
  }

  const letters = /[^A-Za-zÀ-ÖØ-öø-ÿ\s]/g;
  if (nome){ nome.addEventListener("input", e=> e.target.value = e.target.value.replace(letters,"")); }
  if (sobrenome){ sobrenome.addEventListener("input", e=> e.target.value = e.target.value.replace(letters,"")); }
})();
</script>
{% endblock %}
